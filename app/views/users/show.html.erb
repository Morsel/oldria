<% title "#{@user.first_name}'s Profile", false %>

<% if params[:controller] == "profiles" %>
  <p>This is a preview view. These changes have not been saved.<%= link_to_function "Go back", "history.go(-1)" %> to edit or save.</p>
<% end %>

<div id="user_profile_view" class="clearfix">
   <% if current_user == @user %>
	    <div class="edit_profile_link"><a href="<%= edit_my_profile_path %>"><span>Edit profile</span></a></div>
   <% end %>
  
    <div class="profile_info">
        
        <div class="profile_header">
            
            <div class="profile_picture">
                <%= image_tag @user.avatar.url(:small), :width=>'72', :class => 'left' %>
            </div><!-- .profile_picture -->
            <h2 class="user_name"><%= @user.name %></h2>
            <% if @user.profile && @user.profile.headline %>
              <h3 class="headline"><%= @user.profile.try(:headline) %></h3>
            <% end %>
        </div><!--.profile_header-->

        <div class="profile_title_summary">
            <% if @user.employments.any? %>
            <h5 class="nomargin">Title(s)</h5>
            <div>
                <%= @user.primary_employment.try(:restaurant_role).try(:name) %>, 
                <%= link_to_unless (params[:controller] == 'soapbox/profiles'),
                    @user.primary_employment.try(:restaurant).try(:name), 
                    @user.primary_employment.try(:restaurant) %>
            </div>
            <% for employment in @user.nonprimary_employments %>
            <div>
                <%= employment.try(:restaurant_role).try(:name) %>, 
                <%= link_to_unless (params[:controller] == 'soapbox/profiles'),
                    employment.try(:restaurant).try(:name), 
                    employment.try(:restaurant) %>
            </div>
            <% end %>

            <% end %>
  
            <% if @user.profile && @user.profile.summary.present? -%>
              <h5>Summary</h5>
              <p><%= @user.profile.try(:summary) %></p>
            <% end -%>

            <% if @user.profile && @user.profile.specialties.present? %>
              <h5>Specialties</h5>
              <p><%= @user.profile.specialties.map { |s| link_to s.name, directory_search_link(:specialty_id => s.id) }.to_sentence %></p>
            <% end %>

            <% if @user.profile && @user.profile.cuisines.present? %>
              <h5>Cuisine(s)</h5>
              <p><%= @user.profile.cuisines.map { |c| link_to c.name, directory_search_link(:cuisine_id => c.id) }.to_sentence %></p>
            <% end %>

        </div><!--.profile_title_summary-->
		
        <div class="profile_contact_info">
            <h5>Contact Information</h5>
            <dl class="user_info clearfix clear contact">
                <%- unless params[:controller] == 'soapbox/profiles' -%>
                <dt>Acct. Type</dt>
                <dd class="user_account_type"><%= h @user.account_type %></dd>
                <%- end -%>
                
                <% if display_cell(@user) %>
                <dt>Mobile</dt>
                <dd><%= @user.profile.cellnumber %></dd>
                <% end %>

                <%- if display_email(@user) -%>
                <dt>Email</dt>
                <dd><%= mail_to(@user.email, truncate(@user.email, :length => 20)) %></dd>
                <%- end -%>

                <% if display_twitter(@user) %>
                <dt>Twitter</dt>
                <dd><%= link_to @user.twitter_username, "http://twitter.com/#{@user.twitter_username}" %></dd>
                <% end -%>

                <% if display_facebook(@user) %>
                <dt>Facebook</dt>
                <dd><%= link_to @user.facebook_user.name, @user.facebook_user.link %></dd>
                <% end %>
            </dl><!-- .user_info.contact -->
  
			<h5>More Details</h5>
            <dl class="user_info clearfix extra">
                <% if @user.profile %>
                <% if @user.profile.job_start.present? %>
                <dt>Job Start</dt>
                <dd><%= @user.profile.job_start.try(:strftime, '%B %d, %Y') %></dd>
                <% end %>

                <% if @user.profile.birthday.present? %>
                <dt>Age</dt>
                <dd><%= age(@user.profile.birthday) %></dd>
                <% end %>

                <% if @user.profile.hometown.present? %>
                <dt>Hometown</dt>
                <dd><%= @user.profile.hometown %></dd>
                <% end %>

                <% if @user.profile.current_residence.present? %>
                <dt>Current City</dt>
                <dd><%= @user.profile.current_residence %></dd>
                <% end %>

                <% end %>
            </dl><!-- .user_info.extra -->
            <p class="timestamp_header">Last updated:<%= @user.profile.try(:updated_at).try(:strftime, "%b %e %Y") %></p>

        </div><!--.profile_contact_info-->

    </div><!--.profile_info-->

    <%= render :partial => 'users/profile_actions' if !media_or_owner? %>

</div><!-- #user_profile_view -->
  	
<div id="extended_profile_container">
	<a href="#extended_profile" class="showit">View Extended Profile <em>(Education, Experience, Awards, etc)</em></a>
  	
	<%= render 'users/extended_profile', :user => @user, :profile => @user.profile %>
</div><!-- #extended_profile_container -->


<div id="recent_soapbox" class="clearfix">
  	
	<%	 if @user.btl_enabled? && (@user == current_user || @user.published_topics.present?) %>

	<div id="behindline" class="recent_actions">
		
		<h3>Behind the Line: <%= @user.name %></h3>
		<% if current_user == @user %>
			<div class="edit_profile_link">
				<%= link_to "<span>Answer more questions!</span>", topics_user_questions_path(:user_id => @user.id) %>
			</div>
		<% end %>
		<ul class="box">  
			<% for topic in @user == current_user ? @user.topics : @user.published_topics %>
				<li class="<%= cycle("even", "odd") %>">
					<% link_to link_for_chapter(:user_id => @user.id, :topic_id => topic.id) do %>
						<h5><%= topic.title %> <span class="completeness">(<%= topic.completion_percentage(@user) %>% complete)</span></h5>
	  	    	        <%= topic.description %>   
					<% end %>
	  	 	</li>
			<% end %>			
		</ul>
		<p class="view_all"><%= link_to "View all Topics &raquo;", link_for_topics(:user_id => @user.id) %></p>
	</div><!--#behindline-->
	
	<% end %>

	<div id="recent_qtod" class="recent_actions last">
		<h3>Recent responses on Soapbox</h3>
	
	  <div class="tabable">
  	  <nav>
  	    <span><a href="#older_qotds_box">Questions of the Day</a></span>
  	    <span><a href="#older_tqs_box">Trend Questions</a></span>
  	  </nav>
	    
	    <section class="panel-bg">
    	  <div id="older_qotds_box">
    	    <% if @user.qotds_responded.present? %>
    	      <%= render :partial => 'users/question', :collection => @user.qotds_responded, :local => { :user => @user } %>
    	    <% else %>
    	      <p><%= @user.name %> hasn't answered any Questions of the Day yet.</p>
    	    <% end %>
    	  </div><!--#older_qotds_box-->
	
    	  <div id="older_tqs_box">
    	    <% if @user.trend_questions_responded.present? %>
    	      <%= render :partial => 'users/question', 
    	          :collection => @user.trend_questions_responded, 
    	          :local => {:user => @user} %>
    	      <% else %>
    	        <p><%= @user.name %> hasn't answered any Trend Questions yet.</p>
    	      <% end %>
    	  </div><!--#older_tqs_box-->
    	</section>
  	</div><!-- /tabable -->
	</div><!--recent_qtod-->
</div><!-- /recent_soapbox -->